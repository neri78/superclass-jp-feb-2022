(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{400:function(t,e,s){t.exports=s.p+"assets/img/serverless-toolkit-no-editable.da62b7fb.png"},401:function(t,e,s){t.exports=s.p+"assets/img/serveless-protected.b65ae0f9.png"},469:function(t,e,s){"use strict";s.r(e);var a=s(56),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"serverless-toolkitの使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#serverless-toolkitの使用"}},[t._v("#")]),t._v(" Serverless Toolkitの使用")]),t._v(" "),a("p",[t._v("Twilio Functionsは"),a("a",{attrs:{href:"https://www.twilio.com/ja/docs/twilio-cli/quickstart",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twilio CLI"),a("OutboundLink")],1),t._v("および"),a("a",{attrs:{href:"https://www.twilio.com/docs/labs/serverless-toolkit/getting-started#install-the-twilio-serverless-toolkit",target:"_blank",rel:"noopener noreferrer"}},[t._v("Serverless Toolkit"),a("OutboundLink")],1),t._v("を用いてローカル環境で開発する方法を提供しています。\nこのハンズオンでは "),a("strong",[t._v("Serverless Toolkit")]),t._v(" を用いた "),a("strong",[t._v("複数のEnvrionmentへのデプロイ方法")]),t._v(" について重点的に学習します。事前に下記の環境が揃っていることを確認してください。")]),t._v(" "),a("ul",[a("li",[t._v("バージョン12.21以降の"),a("a",{attrs:{href:"https://nodejs.org/ja/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Node.js"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Twilio CLIの"),a("a",{attrs:{href:"https://www.twilio.com/ja/docs/twilio-cli/quickstart",target:"_blank",rel:"noopener noreferrer"}},[t._v("インストール"),a("OutboundLink")],1),t._v("（"),a("a",{attrs:{href:"https://www.twilio.com/ja/docs/twilio-cli/quickstart#twilio%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%B8%E3%81%AE%E3%83%AD%E3%82%AF%E3%82%99%E3%82%A4%E3%83%B3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twilioアカウントへのログイン"),a("OutboundLink")],1),t._v("までを事前に済ませてください）")]),t._v(" "),a("li",[t._v("Twilio Serverless Toolkitの"),a("a",{attrs:{href:"https://www.twilio.com/docs/labs/serverless-toolkit/getting-started#install-the-twilio-serverless-toolkit",target:"_blank",rel:"noopener noreferrer"}},[t._v("インストール"),a("OutboundLink")],1)])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("情報")]),t._v(" "),a("p",[t._v("過去にインストールしたプラグインをアップデートする場合は、"),a("code",[t._v("twilio plugins:update")]),t._v("コマンドを実行します。")])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("すでにCLIをインストールしている場合は、今回のハンズオン用Twilioアカウントの資格情報をCLIで利用しているかどうかを確認してください。新たにプロファイルを作成する場合は、"),a("code",[t._v("twilio profiles:create")]),t._v("コマンドを使用し、作成したプロファイルを"),a("code",[t._v("twilio profiles:use")]),t._v("コマンドで指定します。")])]),t._v(" "),a("p",[a("strong",[t._v("目次")])]),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#ローカル環境にプロジェクトを作成"}},[t._v("ローカル環境にプロジェクトを作成")])]),a("li",[a("a",{attrs:{href:"#プロジェクトのデプロイとコンソールからの制御"}},[t._v("プロジェクトのデプロイとコンソールからの制御")])]),a("li",[a("a",{attrs:{href:"#複数の環境にデプロイ"}},[t._v("複数の環境にデプロイ")])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"ローカル環境にプロジェクトを作成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ローカル環境にプロジェクトを作成"}},[t._v("#")]),t._v(" ローカル環境にプロジェクトを作成")]),t._v(" "),a("p",[t._v("次のコマンドでプロジェクトを作成します。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("twilio serverless:init serverless-handson --template never-gonna-give-you-up\n")])])]),a("p",[t._v("作成後、画面の指示に従い実行します。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" serverless-handson\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" start\n")])])]),a("p",[t._v("この段階で"),a("a",{attrs:{href:"http://localhost:3000/never-gonna-give-you-up",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:3000/never-gonna-give-you-up"),a("OutboundLink")],1),t._v("をブラウザーで開くと、"),a("a",{attrs:{href:"https://jp.twilio.com/docs/voice/twiml/pay",target:"_blank",rel:"noopener noreferrer"}},[t._v("TwiML"),a("OutboundLink")],1),t._v(" が表示されます。")]),t._v(" "),a("p",[t._v("このプロジェクトフォルダーの中にある"),a("code",[t._v("/functions/never-gonna-give-you-up.protected.js")]),t._v("を開くと、先ほどのTwiMLを出力するためのコードを確認できます。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("exports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("handler")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" twiml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Twilio"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("twiml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("VoiceResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  twiml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("play")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://demo.twilio.com/docs/classic.mp3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" twiml"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("情報")]),t._v(" "),a("p",[t._v("Serverless Toolkitを使用する場合は、Visibilityをファイル名で指定します。"),a("code",[t._v("Protected")]),t._v("の場合は、"),a("code",[t._v("aaaa.protected.js")]),t._v("、"),a("code",[t._v("Public")]),t._v("の場合は、"),a("code",[t._v("aaaa.privated.js")]),t._v("と名前をつけてください。")])]),t._v(" "),a("p",[t._v("今回はコードを変更しません。")]),t._v(" "),a("h2",{attrs:{id:"プロジェクトのデプロイとコンソールからの制御"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#プロジェクトのデプロイとコンソールからの制御"}},[t._v("#")]),t._v(" プロジェクトのデプロイとコンソールからの制御")]),t._v(" "),a("p",[t._v("ローカル環境に構築したプロジェクトをクラウド環境にデプロイします。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("twilio serverless:deploy\n")])])]),a("p",[t._v("デプロイ中、次のようなメッセージが表示されます。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Username        SKb*****************************\nPassword        YdTk****************************\nService Name    serverless-handson\nEnvironment     dev\nRoot Directory  /******/serverless-handsOn\nDependencies\ttwilio, @twilio/runtime-handler\nEnv Variables\tTWILIO_VOICE_WEBHOOK_URL\nRuntime\t\tnode12\n\n✔ Serverless project successfully deployed\n\nDeployment Details\nDomain: *****-dev.twil.io\nService:\n   serverless-handsOn (ZS*****************************)\nEnvironment:\n   dev (ZE*****************************) \nBuild SID:\n   ZB*****************************\nView Live Logs:\n   https://www.twilio.com/console/assets/api/\n      ZS*****************************/environment/ZE*****************************\nFunctions:\n   [protected] https://*****-dev.twil.io/my-new-function/hello-world\n   https://*****-dev.twil.io/never-gonna-give-you-up\nAssets:\n\n")])])]),a("p",[t._v("デプロイの際に"),a("code",[t._v("package.json")]),t._v("の"),a("code",[t._v("name")]),t._v("に設定された値をもとに"),a("code",[t._v("Service")]),t._v("が作成されます。特に環境名を指定しない場合、このServiceに"),a("code",[t._v("dev")]),t._v("という名前がついた"),a("code",[t._v("Environment")]),t._v("も併せて作成されます。デプロイ時に使用できるオプションについては"),a("code",[t._v("twilio serverless:deploy --help")]),t._v("コマンドで確認できます。")]),t._v(" "),a("p",[t._v("一旦デプロイを行うとプロジェクトフォルダの"),a("code",[t._v(".twiliodeployinfo")]),t._v("ファイルに各種情報が保存されます。")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"AC********************************"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"serviceSid"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZS********************************"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"latestBuild"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ZB********************************"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("この情報をもとに2回目以降のデプロイ時に新しいビルドの作成、更新が実行されます。")]),t._v(" "),a("p",[t._v("また、Serverless Toolkitを使用したプロジェクトの場合、標準ではUIエディターでの変更は許可されていません。コンソールから該当するサービスを開くと下記のように表示されます。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(400),alt:"function - no edit"}})]),t._v(" "),a("p",[t._v("予期せぬ変更を防ぐため基本的にはローカル環境で開発、テストを行うことが理想的ですが、デプロイ後に手動でコードを変更したい場合は、サービスをCLIから更新しUIの編集を許可できます。この際先ほどのファイルに記録された"),a("code",[t._v("serviceSid (ZS*****************************)")]),t._v("を指定する必要があります。下記のコマンドをデプロイ時に表示された"),a("code",[t._v("serviceSid")]),t._v("を入力し実行してください。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("twilio api:serverless:v1:services:update --sid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("servideSidの値"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --ui-editable\n")])])]),a("p",[t._v("コンソールでの制御を不許可にする場合は"),a("code",[t._v("--no-ui-editable")]),t._v("オプションを指定し、サービスを更新します。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("twilio api:serverless:v1:services:update --sid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("servideSidの値"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --no-ui-editable\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("情報")]),t._v(" "),a("p",[t._v("Twilioコンソールでの制御が不許可になっている場合は、Serviceの削除をUI上から実行できません。ターミナルから次のコマンドを使用します。"),a("br"),t._v(" "),a("code",[t._v("twilio api:serverless:v1:services:remove --sid <servideSidの値>")])])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("上記コマンでサービスを削除した場合は"),a("code",[t._v(".twiliodeployinfo")]),t._v("ファイルの情報をクリアする必要があります。そのままにしておくと、再度デプロイを実行した際にサービスが存在しないというエラーが発生します。")])]),t._v(" "),a("h2",{attrs:{id:"複数の環境にデプロイ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#複数の環境にデプロイ"}},[t._v("#")]),t._v(" 複数の環境にデプロイ")]),t._v(" "),a("p",[t._v("標準では"),a("code",[t._v("dev")]),t._v("というEnvironmentが作成されます。別のEnvironmentを作成する場合は"),a("code",[t._v("twilio serverless:promoate")]),t._v("コマンドを実行します。今回のハンズオンでは、ステージング用のEnvironmentである"),a("code",[t._v("staging")]),t._v("を作成します。指定するオプションについては下記を確認してください。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("オプション名")]),t._v(" "),a("th",[t._v("説明")]),t._v(" "),a("th",[t._v("設定値")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("--service-sid")]),t._v(" "),a("td",[t._v("対象となるServiceのSID")]),t._v(" "),a("td",[t._v("先ほどのデプロイ時に表示された値")])]),t._v(" "),a("tr",[a("td",[t._v("--source-environment または --from")]),t._v(" "),a("td",[t._v("複製元となるEnvironmentの名前またはEnvironment SID")]),t._v(" "),a("td",[t._v("dev")])]),t._v(" "),a("tr",[a("td",[t._v("--environment または --to")]),t._v(" "),a("td",[t._v("複製先のEnviromentの名前またはEnvironment SID")]),t._v(" "),a("td",[t._v("staging")])]),t._v(" "),a("tr",[a("td",[t._v("--create-environment")]),t._v(" "),a("td",[t._v("このフラグを指定すると複製先のEnvironmentが存在しない場合に新規に作成される")]),t._v(" "),a("td",[t._v("フラグを指定")])])])]),t._v(" "),a("p",[t._v("実行するコマンドは次のようになります。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("twilio serverless:promote --service-sid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("serviceSidの値"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n --from"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dev --to"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("staging --create-environment\n")])])]),a("p",[t._v("下記のURL情報を参考に発行された"),a("code",[t._v("staging")]),t._v("のURLをブラウザーで開きます。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("https://serverless-handson-****-staging.twil.io/never-gonna-give-you-up\n")])])]),a("p",[t._v("ローカル環境では"),a("code",[t._v("protected")]),t._v("となっていたFunctionにアクセスできましたが、デプロイ後はリクエストヘッダの署名を確認しているため、アクセスができないことを示すエラーが表示されます。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(401),alt:"serverless - protected"}})]),t._v(" "),a("p",[t._v("この状態をエラーだと仮定し、修正しましょう。"),a("code",[t._v("/functions/never-gonna-give-you-up.protected.js")]),t._v("のファイル名を"),a("code",[t._v("never-gonna-give-you-up.js")]),t._v("と変更し、"),a("code",[t._v("dev")]),t._v("環境にデプロイします。\nデプロイ後、下記のURL情報を参考に"),a("code",[t._v("dev")]),t._v("のURLをブラウザーで開き、TwiMLが返されることを確認します。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("https://serverless-handson-****-dev.twil.io/never-gonna-give-you-up\n")])])]),a("p",[a("code",[t._v("dev")]),t._v("と"),a("code",[t._v("staging")]),t._v("が異なる結果を返すことを確認し、このセクションは完了です。")])])}),[],!1,null,null,null);e.default=n.exports}}]);